# 接口幂等性校验

### 一、概念

幂等性, 通俗的说就是一个接口, 多次发起同一个请求, 必须保证操作只能执行一次
比如:

- 订单接口, 不能多次创建订单
- 支付接口, 重复支付同一笔订单只能扣一次钱
- 支付宝回调接口, 可能会多次回调, 必须处理重复回调
- 普通表单提交接口, 因为网络超时等原因多次点击提交, 只能成功一次
  等等

### 二、常见解决方案

- 唯一索引 -- 防止新增脏数据
- token机制 -- 防止页面重复提交
- 悲观锁 -- 获取数据的时候加锁(锁表或锁行)
- 乐观锁 -- 基于版本号version实现, 在更新数据那一刻校验数据
- 分布式锁 -- redis(jedis、redisson)或zookeeper实现
- 状态机 -- 状态变更, 更新数据时判断状态（其实也是记录状态和token机制差不多）

为了更加的安全和人性化这几种方案需要搭配使用，唯一索引、悲观锁、乐观锁、分布式锁是在最后一道的校验，但是如果只用最后一层势必影响数据库的性能并且返回错误异常并不友好，而token机制不能彻底防止重复提交，却能拦截大多数，并且友好返回

### 三、redis + token机制实现接口幂等性校验

为需要保证幂等性的每一次请求创建一个唯一标识token, 先获取token, 并将此token存入redis, 请求接口时, 将此token放到header或者作为请求参数请求接口, 后端接口判断redis中是否存在此token:

- 如果存在, 正常处理业务逻辑, 并从redis中删除此token, 那么, 如果是重复请求, 由于token已被删除, 则不能通过校验, 返回请勿重复操作提示
- 如果不存在, 说明参数不合法或者是重复请求, 返回提示即可

### 四、项目简介

- springboot
- redis
- @ApiIdempotent注解 + 拦截器对请求进行拦截
- @ControllerAdvice全局异常处理

具体项目  https://github.com/jiuhui/springBoot-security